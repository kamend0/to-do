<!DOCTYPE html>
<html>
  <head>
    <title>Tasks</title>
    <link rel="stylesheet"
          type="text/css"
          href="{{ url_for('static', filename = 'styles/tasks.css') }}">
    </link>
  </head>
  <body>
    <h1>Tasks</h1>
    <ul id="task-list">
      {% for task in tasks %}
        <div id="task_{{ task.id }}" class="task">
          <li id="text_task_{{ task.id }}"
              class="task-text"
          >{{ task.title }} - {{ task.description }}</li>
          <button id="del_task_{{ task.id }}"
                  class="del-button"
                  data-task-id="{{ task.id }}"
          >Delete</button>
        </div>
      {% endfor %}
    </ul>
    <form id="add-task-form">
      <input type="text" id="new-task-title" name="title" placeholder="Title">
      <input type="text" id="new-task-description" name="description" placeholder="Description">
      <button type="submit">Add Task</button>
    </form>
    <script>
      // ADDING TASKS
      var form = document.getElementById('add-task-form');
      var taskList = document.getElementById('task-list');
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        // Grab data we need from submit form
        const title = document.getElementById('new-task-title').value.trim();
        const description = document.getElementById('new-task-description').value.trim();
        const data = {
          title: title,
          description: description
        };
        // Invoke add_task method from views.py
        fetch('/add_task', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // TODO Longer-term, make more dynamic
            // Some work on this has been done: see "dynamicTasks.html" in archive
            location.reload();
          } else {
            alert('Failed to add task: ' + data.message);
          }
        })
        .catch(error => {
          console.error(error);
          alert('An error occurred while adding the task');
        });
      });


      // DELETING TASKS
      // Delete buttons only correctly implemented when page is reloaded
      var delButtons = document.querySelectorAll('.del-button');
      // Then, add an event listener for each button
      delButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          event.preventDefault();
          // Grab data we need: task's unique ID
          const taskID = event.target.dataset.taskId;
          // Invoke delete_task method from views.py
          fetch('/delete_task', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // TODO Longer-term, make more dynamic
              location.reload();
            } else {
              alert('Failed to delete task. Please refresh the page and try again.');
            }
          })
          .catch(error => {
            console.error(error);
            alert('An error occurred while deleting the task');
            });
          });
        });
    </script>
  </body>
</html>